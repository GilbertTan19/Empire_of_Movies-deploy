{% extends 'base.html' %}
{% load threadedcomments_tags %}


{% block javascript %}
    <script type="text/javascript">

        function show_reply_form(event) {
            var $this = $(this);
            var comment_id = $this.data('comment-id');

            $('#id_parent').val(comment_id);
            $('#form-comment').insertAfter($this.closest('.comment'));
        };

        function cancel_reply_form(event) {
            $('#id_comment').val('');
            $('#id_parent').val('');
            $('#form-comment').appendTo($('#wrap_write_comment'));
        }

        $.fn.ready(function() {
            $('.comment_reply_link').click(show_reply_form);
            $('#cancel_reply').click(cancel_reply_form);
        })

    </script>
{% endblock %}

{% block content %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb"> 
    <li class="breadcrumb-item"><a href = "{%url 'movie_list' %}"> Movies  </a> </li>
    <li class="breadcrumb-item"><a href = "{%url 'movie_detail' movie_pk%}"> {{movie_name}}  </a> </li>
    <li class="breadcrumb-item"><a href="{%url 'discussion_list' movie_pk%}"> Discussions  </a> </li>
    <li class="breadcrumb-item active"> {{discussion_name}}  </li>
  </ol>
</nav>
  <br>

<div class="article-entry">
    <div style="overflow:hidden">
      <h2 style="float:left">{{ object.title }}&ensp;</h2> 
      <div style="float:left">
        <!-- Report start -->
        <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#report_discussion">Report</button>
        <div class="modal" id="report_discussion">
          <div class="modal-dialog">
            <div class="modal-content">
            <!-- Modal Header -->
              <div class="modal-header">
                <div class="col-11">
                  <h4 class="modal-title text-center">Report</h4>
                </div>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
              </div>
              <!-- Modal body -->
              <div class="modal-body">
                <form class ='form', method='POST' action = '{% url "report" %}'> {% csrf_token %}
                  <input type='hidden' name ='discussion_id' value='{{discussion.id}}'/>
                  <input type='hidden' name ='reported_id' value='{{discussion.author.id}}'/>
                  <!--<input name="short_reason" class="form-control mr-sm-2" type="text" placeholder="Short Reason" aria-label="Short Reason"> -->
                  <select class="form-control" name="short_reason">
                    <option value="" disabled selected>Select your option</option>
                    <option value="spam">It's a spam</option>
                    <option value="inappropriate">It's inappropriate</option>
                  </select>
                  <br>
                  <input name="long_reason" class="form-control mr-sm-2" type="text" placeholder="More Detail" aria-label="More Detail">
                  <br>
                  <button class="btn btn-danger" style="float:right" type="submit" value="Submit"> Report   </button>
                </form>
              </div>
            </div>
          </div>
        </div>
        <!-- Report end -->
      </div>
      
    </div>
    <p class="text-secondary">by <a href="{{ object.author.get_absolute_url }}">{{ object.author }}</a>  &middot; {{ object.date|timesince }} ago</p>
    <p>{{ object.body }}</p>

  <form class ='form', method='POST' action = '{% url "upvote_discussion" %}'> {% csrf_token %}
              <input type='hidden' name ='title' value='{{discussion.title}}'/>
              {% if is_upvoter %} 
              <button class='btn btn-danger'>
              Un-Upvote
              </button>
              {% else %}
              <button class='btn btn-primary'>
              Upvote
              </button>
              {% endif %} 
  </form>
  <p>{{voters_count}}</p>
  <form class ='form', method='POST' action = '{% url "downvote_discussion" %}'> {% csrf_token %}
              <input type='hidden' name ='title' value='{{discussion.title}}'/>
             {% if is_downvoter %} 
              <button class='btn btn-danger'>
              Un-Downvote
              </button>
              {% else %}
              <button class='btn btn-primary'>
              Downvote
              </button>
              {% endif %} 
  </form>

  {% if user == discussion.author %}
  <p><a href="{% url 'discussion_edit' discussion.movie.pk discussion.pk  %}">Edit</a> 
  | <a href="{% url 'discussion_delete' discussion.movie.pk discussion.pk %}">Delete</a>
  {% endif %}
  </p>
</div>
  {% for comment in comment_list %}
                     <div class="modal" id="report">
                      <div class="modal-dialog">
                        <div class="modal-content">
                        <!-- Modal Header -->
                          <div class="modal-header">
                            <div class="col-11">
                              <h4 class="modal-title text-center">Report</h4>
                            </div>
                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                          </div>
                          <!-- Modal body -->
                          <div class="modal-body">
                            <form class ='form', method='POST' action = '{% url "report" %}'> {% csrf_token %}
                              <input type='hidden' name ='comment_id' value='{{comment.id}}'/>
                              <input type='hidden' name ='reported_id' value='{{comment.author.id}}'/>
                              <!--<input name="short_reason" class="form-control mr-sm-2" type="text" placeholder="Short Reason" aria-label="Short Reason"> -->
                              <select class="form-control" name="short_reason">
                                <option value="" disabled selected>Select your option</option>
                                <option value="spam">It's a spam</option>
                                <option value="inappropriate">It's inappropriate</option>
                              </select>
                              <br>
                              <input name="long_reason" class="form-control mr-sm-2" type="text" placeholder="More Detail" aria-label="More Detail">
                              <br>
                              <button class="btn btn-danger" style="float:right" type="submit" value="Submit"> Report   </button>
                            </form>
                          </div>
                        </div>
                      </div>
                    </div>
                  
    <div class="card">
      <div class="card-header">
        
          <div>
            <span> {{ comment.title }}</span>
          </div>
      </div>
      <div class="card-footer">
        <div class="row">
          <div class="col">
              <div class="dropdown dropright">
                <button type="button" class="btn btn-light dropdown-toggle" data-toggle="dropdown"></button>
                  
                  <div class="dropdown-menu">
                  {% if user == comment.author %}
                    <a class="dropdown-item" href="{% url 'comment_edit' comment.discussion.movie.pk comment.discussion.pk comment.pk  %}">Edit</a> 
                    <a class="dropdown-item" href="{% url 'comment_delete' comment.discussion.movie.pk comment.discussion.pk comment.pk %}">Delete</a>
                  {% endif %}
                    <!-- Report start -->
                     <a class="dropdown-item" data-toggle="modal" data-target="#report">Report</a>
                  
                  </div>
              </div>
              
          </div>
          <div class="col-auto row align-items-center mr-1">
            <div class="align-self-center">
              <span><a href="{{ comment.author.get_absolute_url }}">{{ comment.author }}</a> &middot; {{ comment.date|timesince }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    <br />
  {% endfor %}


{% get_comment_list for object as comment_list %}
    <div class="comments_wrapper" id="comments">
        <div class="comments_length">
            <p>{{ comment_list|length }} Comments</p>
        </div>

        <div class="comments">
            {% for comment in comment_list|fill_tree|annotate_tree %}{% ifchanged comment.parent_id %}{% else %}</li>{% endifchanged %}{% if not comment.open and not comment.close %}</li>{% endif %}{% if comment.open %}
                <ul>{% endif %}
            <li class="comment_li" id="c{{ comment.id }}">{# c## is used by the absolute URL of the Comment model, so keep that as it is. #}
                <div class="comment">
                    <div class="comment_info">
                        <div class="comment_user">{{ comment.user_name }}</div>
                        <div class="comment_data">
                            {{ comment.submit_date|date:"d M Y, H:i" }}
                          | <a href="#c{{ comment.id }}" data-comment-id="{{ comment.id }}" class="comment_reply_link">Reply</a>
                        </div>
                    </div>
                    <div class="comment_text">
                        {{ comment.comment }}
                    </div>
                </div>
                {% for close in comment.close %}</li></ul>{% endfor %}

            {% endfor %}
        </div>

        <div id="wrap_write_comment">
            <div id="form-comment">
                {% get_comment_form for object as form %}
                <form action="/comments/post/" method="post">{% csrf_token %}
                    {{ form.as_p }}{# just to keep the example simple. Consider using django-crispy-forms in real life #}
                    <input type="hidden" value={{user.username}} name="name" maxlength="50" required="" id="id_name">
                    <p>
                      <input type="submit" value="Submit Comment"/>
                      <a href="#c0" id="cancel_reply">cancel reply</a>
                    </p>
                </form>
            </div>
        </div>
    </div>

                
{% endblock content %}